{% extends 'volunteer/base.html' %}

{% block title %}{% if view == 'delivery_route' %}My Deliveries{% else %}My Pickups{% endif %} - {{ block.super }}{% endblock %}
{% block page_title %}{% if view == 'delivery_route' %}My Deliveries{% else %}My Pickups{% endif %}{% endblock %}
{% block page_description %}{% if view == 'delivery_route' %}Deliver collected items to the nearest donation camp.{% else %}Accept and collect food donations from restaurants.{% endif %}{% endblock %}

{% block volunteer_content %}
<style>
    /* Stats Cards */
    .pickup-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 16px;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid #e5e7eb;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .stat-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #111827;
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 4px;
    }
    .stat-card.highlight {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    .stat-card.highlight .stat-value,
    .stat-card.highlight .stat-label {
        color: white;
    }
    
    /* Route Info Banner */
    .route-info-banner {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }
    .route-info-banner .route-details {
        display: flex;
        gap: 32px;
        flex-wrap: wrap;
    }
    .route-info-banner .route-detail {
        text-align: center;
    }
    .route-info-banner .route-detail-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    .route-info-banner .route-detail-label {
        font-size: 0.8rem;
        opacity: 0.9;
    }
    
    /* Live Tracking Indicator */
    .live-tracking-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        font-size: 0.9rem;
    }
    .pulse-dot {
        width: 10px;
        height: 10px;
        background: #fbbf24;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    /* Map Container */
    .pickup-map-container {
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
        position: relative;
    }
    #pickup-route-map, #delivery-map {
        height: 400px;
        width: 100%;
    }
    .map-legend {
        position: absolute;
        bottom: 12px;
        left: 12px;
        background: white;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
        font-size: 0.8rem;
    }
    .map-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }
    .map-legend-item:last-child {
        margin-bottom: 0;
    }
    .legend-marker {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    /* Warning Banner */
    .warning-banner {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .warning-banner svg {
        width: 24px;
        height: 24px;
        color: #d97706;
        flex-shrink: 0;
    }
    .warning-banner p {
        margin: 0;
        color: #92400e;
        font-weight: 500;
    }
    
    /* Info Banner */
    .info-banner {
        background: #eff6ff;
        border: 1px solid #3b82f6;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .info-banner svg {
        width: 24px;
        height: 24px;
        color: #2563eb;
        flex-shrink: 0;
    }
    .info-banner p {
        margin: 0;
        color: #1e40af;
    }
    
    /* Pickup List */
    .pickup-list-modern {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .pickup-item-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .pickup-item-card:hover {
        border-color: #10b981;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
    }
    .pickup-item-card.highlighted {
        border-color: #3b82f6;
        background: #f0f9ff;
    }
    .pickup-item-info h4 {
        margin: 0 0 4px 0;
        font-size: 1rem;
        color: #111827;
    }
    .pickup-item-info p {
        margin: 0;
        font-size: 0.875rem;
        color: #6b7280;
    }
    .pickup-item-info .address-text {
        font-size: 0.8rem;
        color: #9ca3af;
    }
    .pickup-order-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #10b981;
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        margin-right: 12px;
    }
    
    /* Buttons */
    .btn-collect {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
    }
    .btn-collect:hover {
        background: #2563eb;
    }
    .btn-collect:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-primary-action {
        background: #10b981;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
    }
    .btn-primary-action:hover {
        background: #059669;
        transform: translateY(-1px);
    }
    .btn-primary-action:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary-action {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    .btn-secondary-action:hover {
        background: #e5e7eb;
    }
    
    /* Delivery Info Container */
    .delivery-info-container {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px 24px;
        margin-top: 16px;
    }
    .delivery-info-container .camp-details h4 {
        margin: 0 0 8px 0;
        color: #111827;
        font-size: 1.1rem;
    }
    .delivery-info-container .camp-details p {
        margin: 0 0 4px 0;
        color: #6b7280;
        font-size: 0.9rem;
    }
    
    /* History Tabs (only for My Deliveries) */
    .delivery-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0;
    }
    .delivery-tab {
        padding: 12px 20px;
        border: none;
        background: none;
        font-size: 0.95rem;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
        text-decoration: none;
    }
    .delivery-tab:hover {
        color: #374151;
    }
    .delivery-tab.active {
        color: #10b981;
        border-bottom-color: #10b981;
    }
    
    /* Location detection status */
    .location-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f0fdf4;
        border: 1px solid #86efac;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #166534;
        margin-bottom: 1rem;
    }
    .location-status.loading {
        background: #fef3c7;
        border-color: #fcd34d;
        color: #92400e;
    }
    .location-status.error {
        background: #fef2f2;
        border-color: #fca5a5;
        color: #991b1b;
    }
</style>

{# ============ MODE A: MY PICKUPS (Collection Phase) ============ #}
{% if view != 'delivery_route' %}

{# Stats Bar #}
<div class="pickup-stats">
    <div class="stat-card">
        <div class="stat-value">{{ active_donations.count }}/10</div>
        <div class="stat-label">Active Pickups</div>
    </div>
    <div class="stat-card {% if collected_count > 0 %}highlight{% endif %}">
        <div class="stat-value" id="collected-count">{{ collected_count|default:0 }}</div>
        <div class="stat-label">Items Collected</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ pending_verification_count|default:0 }}</div>
        <div class="stat-label">Pending Verification</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ total_deliveries|default:0 }}</div>
        <div class="stat-label">Total Deliveries</div>
    </div>
</div>

{# Active Pickups Section #}
{% if active_donations %}
<div class="content-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 12px;">
        <h3 style="margin: 0;">My Active Pickups</h3>
        <button class="btn-primary-action" onclick="calculateOptimizedRoute()" id="calculate-route-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
            Calculate Best Route
        </button>
    </div>
    
    {# Location Detection Status #}
    <div class="location-status loading" id="location-status">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
        <span id="location-status-text">Detecting your current location...</span>
    </div>
    
    {# Route Map (hidden until calculated) #}
    <div class="pickup-map-container" id="pickup-map-container" style="display: none;">
        <div id="pickup-route-map"></div>
        <div class="map-legend">
            <div class="map-legend-item">
                <div class="legend-marker" style="background: #10b981;"></div>
                <span>Your Location</span>
            </div>
            <div class="map-legend-item">
                <div class="legend-marker" style="background: #3b82f6;"></div>
                <span>Restaurant Pickup</span>
            </div>
        </div>
    </div>
    
    {# Route Info Banner (hidden until calculated) #}
    <div class="route-info-banner" id="route-info-banner" style="display: none;">
        <div class="route-details">
            <div class="route-detail">
                <div class="route-detail-value" id="route-distance">--</div>
                <div class="route-detail-label">Distance (km)</div>
            </div>
            <div class="route-detail">
                <div class="route-detail-value" id="route-time">--</div>
                <div class="route-detail-label">Est. Time (min)</div>
            </div>
            <div class="route-detail">
                <div class="route-detail-value" id="route-stops">{{ active_donations.count }}</div>
                <div class="route-detail-label">Stops</div>
            </div>
        </div>
        <div class="live-tracking-indicator" id="live-tracking-status" style="display: none;">
            <span class="pulse-dot"></span>
            Live Tracking
        </div>
    </div>
    
    <div class="pickup-list-modern" id="pickup-list">
        {% for donation in active_donations %}
        <div class="pickup-item-card" id="pickup-card-{{ donation.pk }}" data-donation-id="{{ donation.pk }}" 
             data-lat="{{ donation.restaurant.latitude }}" data-lon="{{ donation.restaurant.longitude }}">
            <div style="display: flex; align-items: center;">
                <span class="pickup-order-badge" id="order-badge-{{ donation.pk }}" style="display: none;">-</span>
                <div class="pickup-item-info">
                    <h4>{{ donation.restaurant.restaurant_name }}</h4>
                    <p>{{ donation.food_description }}</p>
                    <p class="address-text">{{ donation.pickup_address }}</p>
                </div>
            </div>
            <div class="pickup-item-status">
                {% if donation.status == 'ACCEPTED' %}
                    <button class="btn-collect" id="collect-btn-{{ donation.pk }}" onclick="markAsCollected({{ donation.pk }})">
                        Mark as Collected
                    </button>
                {% elif donation.status == 'COLLECTED' %}
                    <span class="status-badge status-collected">Collected</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    {# Proceed to Delivery Button #}
    {% if collected_count > 0 and uncollected_count == 0 %}
    <div style="margin-top: 1.5rem; text-align: center;">
        <a href="{% url 'volunteer_manage_pickups' %}?view=delivery_route" class="btn-primary-action">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14"/>
                <path d="m12 5 7 7-7 7"/>
            </svg>
            Proceed to Delivery Mode
        </a>
    </div>
    {% elif collected_count > 0 and uncollected_count > 0 %}
    <div class="info-banner" style="margin-top: 1rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
        <p>Collect all {{ uncollected_count }} remaining item(s) before proceeding to delivery.</p>
    </div>
    {% endif %}
</div>
{% endif %}

{# Available Donations Section #}
<div class="content-card">
    <form method="GET" action="{% url 'volunteer_manage_pickups' %}" style="margin-bottom: 1.5rem;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="text" name="q" placeholder="Search by restaurant name or pickup address..." 
                   value="{{ request.GET.q }}" 
                   style="flex: 1; min-width: 200px; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 0.95rem;">
            <button type="submit" class="btn-primary-action">Search</button>
            {% if request.GET.q %}
            <a href="{% url 'volunteer_manage_pickups' %}" class="btn-secondary-action">Clear</a>
            {% endif %}
        </div>
    </form>
    
    <h3>Available Donations for Pickup</h3>
    {% if available_donations %}
    <table class="data-table">
        <thead>
            <tr><th>Restaurant</th><th>Food Description</th><th>Address</th><th>Action</th></tr>
        </thead>
        <tbody id="available-donations-tbody">
            {% for donation in available_donations %}
            <tr id="donation-row-{{ donation.pk }}">
                <td data-label="Restaurant"><strong>{{ donation.restaurant.restaurant_name }}</strong></td>
                <td data-label="Food Description">{{ donation.food_description }}</td>
                <td data-label="Address">{{ donation.pickup_address }}</td>
                <td data-label="Action">
                    {% if active_donations.count < 10 %}
                    <button type="button" class="action-button" id="accept-btn-{{ donation.pk }}" 
                            data-testid="accept-donation-btn-{{ donation.pk }}" onclick="acceptDonation({{ donation.pk }})">
                        Accept
                    </button>
                    {% else %}
                    <button class="action-button" data-testid="pickup-limit-reached-btn" disabled>
                        Limit Reached (10)
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">There are no available donations right now. Check back later.</p>
    {% endif %}
</div>

{# ============ MODE B: MY DELIVERIES (Drop-off Phase) ============ #}
{% else %}

{# Stats Bar for Deliveries #}
<div class="pickup-stats">
    <div class="stat-card highlight">
        <div class="stat-value">{{ collected_count|default:0 }}</div>
        <div class="stat-label">Ready to Deliver</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ pending_verification_count|default:0 }}</div>
        <div class="stat-label">Pending Verification</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ total_deliveries|default:0 }}</div>
        <div class="stat-label">Total Completed</div>
    </div>
</div>

{# Delivery Tabs: Current / History #}
<div class="delivery-tabs">
    <a href="{% url 'volunteer_manage_pickups' %}?view=delivery_route" 
       class="delivery-tab {% if request.GET.tab != 'history' %}active{% endif %}">
        Current Delivery
    </a>
    <a href="{% url 'volunteer_manage_pickups' %}?view=delivery_route&tab=history" 
       class="delivery-tab {% if request.GET.tab == 'history' %}active{% endif %}">
        Delivery History
    </a>
</div>

{% if request.GET.tab == 'history' %}
{# ============ HISTORY TAB ============ #}
<div class="content-card">
    <h3>My Delivery History</h3>
    <table class="data-table">
        <thead>
            <tr><th>Description</th><th>From</th><th>Delivered To</th><th>Status</th><th>Date</th></tr>
        </thead>
        <tbody>
            {% for donation in delivery_history %}
            <tr>
                <td data-label="Description">{{ donation.food_description }}</td>
                <td data-label="From">{{ donation.restaurant.restaurant_name }}</td>
                <td data-label="Delivered To">{{ donation.target_camp.name|default:"N/A" }}</td>
                <td data-label="Status">
                    <span class="status-badge status-{{ donation.status|lower }}">
                        {% if donation.status == 'VERIFICATION_PENDING' %}Pending Verification{% else %}{{ donation.get_status_display }}{% endif %}
                    </span>
                </td>
                <td data-label="Date">{{ donation.delivered_at|date:"d M Y, H:i" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="empty-state">You have no completed deliveries yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
{# ============ CURRENT DELIVERY TAB ============ #}

{# Guard Logic Warning #}
{% if has_uncollected_items %}
<div class="warning-banner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg>
    <p>Complete your current pickups before delivering. You have {{ uncollected_count }} item(s) still marked as "Accepted" but not yet collected.</p>
</div>
{% endif %}

{# Delivery Content #}
<div class="content-card">
    <h3>Deliver to Nearest Camp</h3>
    
    {# Location Detection Status #}
    <div class="location-status loading" id="delivery-location-status">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
        <span id="delivery-location-text">Detecting your current location...</span>
    </div>
    
    {% if nearest_camp %}
        {# Map #}
        <div class="pickup-map-container">
            <div id="delivery-map"></div>
            <div class="map-legend">
                <div class="map-legend-item">
                    <div class="legend-marker" style="background: #10b981;"></div>
                    <span>Your Location</span>
                </div>
                <div class="map-legend-item">
                    <div class="legend-marker" style="background: #ef4444;"></div>
                    <span>Donation Camp</span>
                </div>
            </div>
        </div>
        
        {# Route Info #}
        <div class="route-info-banner">
            <div class="route-details">
                <div class="route-detail">
                    <div class="route-detail-value" id="delivery-distance">{{ nearest_distance_km }}</div>
                    <div class="route-detail-label">Distance (km)</div>
                </div>
                <div class="route-detail">
                    <div class="route-detail-value" id="delivery-eta">{{ nearest_eta_minutes }}</div>
                    <div class="route-detail-label">Est. Time (min)</div>
                </div>
                <div class="route-detail">
                    <div class="route-detail-value">{{ collected_count|default:0 }}</div>
                    <div class="route-detail-label">Items to Deliver</div>
                </div>
            </div>
            <div class="live-tracking-indicator" id="delivery-live-tracking">
                <span class="pulse-dot"></span>
                Live Tracking
            </div>
        </div>
        
        {# Camp Details & Confirm Button #}
        <div class="delivery-info-container">
            <div class="camp-details">
                <h4>{{ nearest_camp.name }}</h4>
                <p>{{ nearest_camp.ngo.ngo_name }}</p>
                <p>{{ nearest_camp.location_address }}</p>
            </div>
            
            <form action="{% url 'mark_as_delivered' nearest_camp.pk %}" method="POST" style="margin-top: 1.5rem;">
                {% csrf_token %}
                <button type="submit" class="btn-primary-action" {% if has_uncollected_items or collected_count == 0 %}disabled{% endif %}>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Confirm Delivery at Camp
                </button>
            </form>
        </div>
    {% else %}
        <p class="empty-state">No active donation camps found from your registered NGOs. Please register with an NGO first.</p>
        <a href="{% url 'volunteer_manage_camps' %}" class="btn-secondary-action" style="margin-top: 1rem; display: inline-block;">
            Browse NGOs
        </a>
    {% endif %}
</div>

{# Items to Deliver List #}
{% if active_donations %}
<div class="content-card">
    <h3>Items to Deliver ({{ collected_count|default:0 }})</h3>
    <div class="pickup-list-modern">
        {% for donation in active_donations %}
        {% if donation.status == 'COLLECTED' %}
        <div class="pickup-item-card">
            <div class="pickup-item-info">
                <h4>{{ donation.restaurant.restaurant_name }}</h4>
                <p>{{ donation.food_description }}</p>
            </div>
            <span class="status-badge status-collected">Ready</span>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

{% endif %} {# End current/history tab check #}

{% endif %} {# End Mode A/B check #}

{% endblock %}

{% block scripts %}
{{ block.super }}

{% load static %}
<script src="{% static 'js/common.js' %}"></script>
<script src="{% static 'js/volunteer_pickups.js' %}"></script>

{# Pass Django template data to JavaScript #}
{% if view == 'delivery_route' and nearest_camp_data %}
    {{ volunteer_location_data|json_script:"volunteer-location-data" }}
    {{ nearest_camp_data|json_script:"nearest-camp-data" }}
{% endif %}

<script>
    document.body.dataset.currentView = "{{ view }}";
    
    // Current live location storage
    let currentGPSLocation = null;
    let locationWatchId = null;
    
    // Start detecting GPS location immediately
    document.addEventListener('DOMContentLoaded', function() {
        startLocationDetection();
        
        {% if view == 'delivery_route' and nearest_camp_data and request.GET.tab != 'history' %}
        initializeDeliveryMap();
        {% endif %}
    });
    
    /**
     * Start GPS location detection
     */
    function startLocationDetection() {
        const statusEl = document.getElementById('location-status') || document.getElementById('delivery-location-status');
        const textEl = document.getElementById('location-status-text') || document.getElementById('delivery-location-text');
        
        if (!navigator.geolocation) {
            if (statusEl) {
                statusEl.classList.remove('loading');
                statusEl.classList.add('error');
            }
            if (textEl) textEl.textContent = 'Geolocation is not supported by your browser';
            return;
        }
        
        // Use watchPosition for continuous updates
        locationWatchId = navigator.geolocation.watchPosition(
            function(position) {
                currentGPSLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                if (statusEl) {
                    statusEl.classList.remove('loading', 'error');
                }
                if (textEl) {
                    textEl.textContent = `Location detected (accuracy: ${Math.round(position.coords.accuracy)}m)`;
                }
                
                // Update server with location
                sendLocationUpdate(currentGPSLocation.lat, currentGPSLocation.lon, currentGPSLocation.accuracy);
            },
            function(error) {
                if (statusEl) {
                    statusEl.classList.remove('loading');
                    statusEl.classList.add('error');
                }
                let message = 'Unable to detect location';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Please allow location access for route calculation';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Location unavailable - using profile address as fallback';
                        break;
                    case error.TIMEOUT:
                        message = 'Location request timed out - retrying...';
                        break;
                }
                if (textEl) textEl.textContent = message;
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 5000
            }
        );
    }
    
    /**
     * Send location update to server
     */
    function sendLocationUpdate(lat, lon, accuracy) {
        fetch('/api/update-volunteer-location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ latitude: lat, longitude: lon, accuracy: accuracy })
        }).catch(err => console.error('Failed to update location:', err));
    }
    
    // ============ PICKUP ROUTE CALCULATION (Mode A) ============
    let pickupMapInstance = null;
    let routingControl = null;
    let volunteerMarker = null;
    
    function calculateOptimizedRoute() {
        const btn = document.getElementById('calculate-route-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Calculating...';
        
        // Build request body with current GPS location if available
        const requestBody = {};
        if (currentGPSLocation) {
            requestBody.current_lat = currentGPSLocation.lat;
            requestBody.current_lon = currentGPSLocation.lon;
        }
        
        fetch('/api/calculate-pickup-route/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPickupRoute(data);
                showToast('Optimal route calculated from your current location!', 'success');
            } else {
                showToast(data.message || 'Failed to calculate route', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg> Recalculate Route`;
        });
    }
    
    function displayPickupRoute(data) {
        const mapContainer = document.getElementById('pickup-map-container');
        const infoBanner = document.getElementById('route-info-banner');
        
        mapContainer.style.display = 'block';
        infoBanner.style.display = 'flex';
        
        // Update route info
        document.getElementById('route-distance').textContent = data.total_distance_km;
        document.getElementById('route-time').textContent = data.estimated_time_minutes;
        document.getElementById('route-stops').textContent = data.total_pickups;
        
        // Update pickup order badges
        data.route.forEach((loc, index) => {
            if (index > 0) { // Skip volunteer location
                const badge = document.getElementById(`order-badge-${loc.id}`);
                if (badge) {
                    badge.textContent = index;
                    badge.style.display = 'inline-flex';
                }
                // Highlight the card
                const card = document.getElementById(`pickup-card-${loc.id}`);
                if (card && index === 1) {
                    card.classList.add('highlighted');
                }
            }
        });
        
        // Initialize or update map
        if (!pickupMapInstance) {
            pickupMapInstance = L.map('pickup-route-map', {
                zoomControl: true,
                attributionControl: false
            });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickupMapInstance);
        }
        
        // Clear existing routing
        if (routingControl) {
            pickupMapInstance.removeControl(routingControl);
        }
        
        // Create waypoints from route data
        const waypoints = data.route.map(loc => L.latLng(loc.lat, loc.lon));
        
        // Custom bike icon for volunteer
        const bikeIcon = L.divIcon({
            className: 'volunteer-marker',
            html: `<div style="width:36px;height:36px;background:#10b981;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/>
                    <path d="M15 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-3 11.5V14l-3-3 4-3 2 3h2"/>
                </svg>
            </div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        
        // Add routing with custom markers
        routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            createMarker: function(i, waypoint, n) {
                const loc = data.route[i];
                if (i === 0) {
                    // Volunteer marker (you)
                    volunteerMarker = L.marker(waypoint.latLng, { icon: bikeIcon, zIndexOffset: 1000 })
                        .bindPopup('<strong>You are here</strong>');
                    return volunteerMarker;
                } else {
                    // Restaurant markers with order numbers
                    const restaurantIcon = L.divIcon({
                        className: 'restaurant-marker',
                        html: `<div style="width:32px;height:32px;background:#3b82f6;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;">${i}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    return L.marker(waypoint.latLng, { icon: restaurantIcon })
                        .bindPopup(`<strong>Stop ${i}: ${loc.name}</strong>`);
                }
            },
            lineOptions: {
                styles: [{ color: '#10b981', weight: 5, opacity: 0.8 }]
            }
        }).addTo(pickupMapInstance);
        
        // Fit bounds
        pickupMapInstance.fitBounds(waypoints.map(w => [w.lat, w.lng]), { padding: [30, 30] });
        
        // Start live tracking indicator
        document.getElementById('live-tracking-status').style.display = 'flex';
        
        // Update volunteer marker position on GPS updates
        if (locationWatchId !== null && volunteerMarker) {
            // Already watching, marker will be updated
        }
    }
    
    // ============ DELIVERY MAP (Mode B) ============
    let deliveryMapInstance = null;
    let deliveryVolunteerMarker = null;
    
    function initializeDeliveryMap() {
        const volunteerDataEl = document.getElementById('volunteer-location-data');
        const campDataEl = document.getElementById('nearest-camp-data');
        const mapContainer = document.getElementById('delivery-map');
        
        if (!mapContainer || !campDataEl) return;
        
        const campData = JSON.parse(campDataEl.textContent);
        
        // Wait for GPS location or use fallback
        function initMap(startLat, startLon) {
            if (typeof L === 'undefined') {
                mapContainer.innerHTML = '<p class="empty-state">Map library failed to load.</p>';
                return;
            }
            
            deliveryMapInstance = L.map('delivery-map', {
                zoomControl: true,
                attributionControl: false
            }).setView([startLat, startLon], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(deliveryMapInstance);
            
            // Custom bike icon
            const bikeIcon = L.divIcon({
                className: 'volunteer-marker',
                html: `<div style="width:36px;height:36px;background:#10b981;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/>
                        <path d="M15 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-3 11.5V14l-3-3 4-3 2 3h2"/>
                    </svg>
                </div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            
            // Camp icon
            const campIcon = L.divIcon({
                className: 'camp-marker',
                html: `<div style="width:36px;height:36px;background:#ef4444;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            
            // Add volunteer marker
            deliveryVolunteerMarker = L.marker([startLat, startLon], { icon: bikeIcon, zIndexOffset: 1000 })
                .addTo(deliveryMapInstance)
                .bindPopup('<strong>You are here</strong>');
            
            // Add camp marker
            L.marker([campData.latitude, campData.longitude], { icon: campIcon })
                .addTo(deliveryMapInstance)
                .bindPopup(`<strong>${campData.name}</strong><br>${campData.ngo_name}<br><small>${campData.address}</small>`);
            
            // Add routing if Leaflet Routing is available
            if (typeof L.Routing !== 'undefined') {
                L.Routing.control({
                    waypoints: [
                        L.latLng(startLat, startLon),
                        L.latLng(campData.latitude, campData.longitude)
                    ],
                    routeWhileDragging: false,
                    show: false,
                    addWaypoints: false,
                    createMarker: function() { return null; }, // We already added markers
                    lineOptions: {
                        styles: [{ color: '#10b981', weight: 5, opacity: 0.8 }]
                    }
                }).addTo(deliveryMapInstance);
            }
            
            // Fit bounds
            deliveryMapInstance.fitBounds([
                [startLat, startLon],
                [campData.latitude, campData.longitude]
            ], { padding: [50, 50] });
            
            // Update location status
            const statusEl = document.getElementById('delivery-location-status');
            if (statusEl) {
                statusEl.classList.remove('loading');
            }
        }
        
        // If we have GPS location, use it; otherwise wait briefly then use fallback
        if (currentGPSLocation) {
            initMap(currentGPSLocation.lat, currentGPSLocation.lon);
        } else if (volunteerDataEl) {
            const volunteerData = JSON.parse(volunteerDataEl.textContent);
            // Wait for GPS, then fallback
            setTimeout(() => {
                if (currentGPSLocation) {
                    initMap(currentGPSLocation.lat, currentGPSLocation.lon);
                } else {
                    initMap(volunteerData.lat, volunteerData.lon);
                }
            }, 2000);
        }
        
        // Update volunteer marker when GPS updates
        const originalWatchCallback = navigator.geolocation.watchPosition;
        // We'll update the marker in the existing watch callback
    }
    
    // Update delivery volunteer marker when GPS location changes
    setInterval(function() {
        if (currentGPSLocation && deliveryVolunteerMarker) {
            deliveryVolunteerMarker.setLatLng([currentGPSLocation.lat, currentGPSLocation.lon]);
            
            // Update distance/ETA display
            const campDataEl = document.getElementById('nearest-camp-data');
            if (campDataEl) {
                const campData = JSON.parse(campDataEl.textContent);
                const distance = haversineDistance(
                    currentGPSLocation.lat, currentGPSLocation.lon,
                    campData.latitude, campData.longitude
                );
                const eta = Math.round((distance / 20) * 60); // 20 km/h avg
                
                const distEl = document.getElementById('delivery-distance');
                const etaEl = document.getElementById('delivery-eta');
                if (distEl) distEl.textContent = distance.toFixed(2);
                if (etaEl) etaEl.textContent = eta;
            }
        }
        
        // Also update pickup map volunteer marker
        if (currentGPSLocation && volunteerMarker) {
            volunteerMarker.setLatLng([currentGPSLocation.lat, currentGPSLocation.lon]);
        }
    }, 3000);
    
    // Haversine distance calculation
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (locationWatchId !== null) {
            navigator.geolocation.clearWatch(locationWatchId);
        }
    });
</script>
{% endblock scripts %}

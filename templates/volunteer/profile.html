{% extends 'volunteer/base.html' %}

{% block title %}My Profile - {{ block.super }}{% endblock %}

{% block page_title %}My Profile{% endblock %}
{% block page_description %}Update your public information and location.{% endblock %}

{% block volunteer_content %}
<style>
    /* Skills display styles */
    .skills-display-container {
        margin-top: 0.5rem;
    }
    
    .skills-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .skill-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.875rem;
        background: var(--accent-primary-light, rgba(0, 173, 181, 0.1));
        color: var(--accent-primary, #00adb5);
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .skill-badge .check-icon {
        width: 14px;
        height: 14px;
        color: var(--accent-green, #28a745);
    }
    
    .no-skills-text {
        color: var(--text-muted, #6c757d);
        font-style: italic;
    }
    
    /* Skills edit mode */
    .skills-edit-container {
        display: none;
    }
    
    .skills-checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .skill-checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--bg-card-hover, #f8f9fa);
        border: 1px solid var(--border, #dee2e6);
        border-radius: var(--radius, 0.5rem);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .skill-checkbox-item:hover {
        border-color: var(--accent-primary, #00adb5);
    }
    
    .skill-checkbox-item input[type="checkbox"] {
        width: auto;
        margin: 0;
    }
    
    .skill-checkbox-item input[type="checkbox"]:checked + .skill-label {
        color: var(--accent-primary, #00adb5);
        font-weight: 600;
    }
    
    .skill-checkbox-item:has(input:checked) {
        background: var(--accent-primary-light, rgba(0, 173, 181, 0.1));
        border-color: var(--accent-primary, #00adb5);
    }
    
    .skill-label {
        font-size: 0.875rem;
    }
    
    /* Edit mode active state */
    body.edit-mode .skills-display-container {
        display: none;
    }
    
    body.edit-mode .skills-edit-container {
        display: block;
    }
</style>

<div class="profile-container">
    <div class="profile-form">
        <form method="POST" enctype="multipart/form-data" action="{% url 'volunteer_profile' %}" id="profile-form">
            {% csrf_token %}
            {{ form.latitude }}
            {{ form.longitude }}

            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label for="id_username">Username</label>
                        <input type="text" name="username" id="id_username" value="{{ user.username }}" maxlength="150" class="{% if username_error %}input-error{% endif %}">
                        {% if username_error %}
                            <p class="field-error">{{ username_error }}</p>
                        {% endif %}
                        <p class="form-help-text">Your unique username for login and display.</p>
                    </div>
                    <div class="form-group">
                        {{ form.full_name.label_tag }}
                        {{ form.full_name }}
                    </div>
                    <div class="form-group">
                        {{ form.phone_number.label_tag }}
                        {{ form.phone_number }}
                    </div>
                    
                    <!-- Skills Section with View/Edit Mode -->
                    <div class="form-group">
                        <label>Skills</label>
                        
                        <!-- View Mode: Show only selected skills as badges -->
                        <div class="skills-display-container" id="skills-display">
                            <div class="skills-badges">
                                {% if form.instance.skills %}
                                    {% for skill in form.instance.skills.split %}
                                        {% if skill %}
                                        <span class="skill-badge">
                                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="20 6 9 17 4 12"/>
                                            </svg>
                                            {{ skill|cut:"," }}
                                        </span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="no-skills-text">No skills added yet. Click Edit to add your skills.</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Edit Mode: Show all skills as checkboxes -->
                        <div class="skills-edit-container" id="skills-edit">
                            <div class="skills-checkbox-group">
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="driving" {% if 'Driving' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">Driving</span>
                                </label>
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="first_aid" {% if 'First Aid' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">First Aid</span>
                                </label>
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="cooking" {% if 'Cooking' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">Cooking</span>
                                </label>
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="logistics" {% if 'Logistics' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">Logistics</span>
                                </label>
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="communication" {% if 'Communication' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">Communication</span>
                                </label>
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="medical" {% if 'Medical' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">Medical</span>
                                </label>
                                <label class="skill-checkbox-item">
                                    <input type="checkbox" name="skills" value="packaging" {% if 'Packaging' in form.instance.skills %}checked{% endif %}>
                                    <span class="skill-label">Packaging</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="image-upload-section">
                    <div class="image-upload-widget">
                        <label>Profile Picture</label>
                        <div class="image-preview-container">
                            <img src="{% if form.instance.profile_picture %}{{ form.instance.profile_picture.url }}{% else %}https://placehold.co/120x120/e2e8f0/475569?text=Photo{% endif %}"
                                alt="Profile Picture" class="image-preview" id="profile_picture_preview">
                        </div>
                        <input type="file" id="id_profile_picture_input" accept="image/*"
                            onchange="modernCropperOpen(event, 1, 'id_profile_picture')" style="display: none;">
                        <button type="button" class="upload-btn image-upload-btn"
                            onclick="document.getElementById('id_profile_picture_input').click()">
                            Choose Image
                        </button>
                    </div>
                </div>
            </div>

            <div style="display: none;">
                {{ form.profile_picture }}
            </div>

            <div class="map-section">
                <h3>Location & Address</h3>
                <div class="form-group">
                    {{ form.address.label_tag }}
                    <div class="address-group">
                        {{ form.address }}
                        <button type="button" class="map-action-btn" onclick="findAddressOnMap()">Find Location</button>
                        <button type="button" class="map-action-btn find-my-location-btn" onclick="findMyLocation()" style="background-color: #10b981;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
                                <circle cx="12" cy="12" r="10"/>
                                <circle cx="12" cy="12" r="3"/>
                                <line x1="12" y1="2" x2="12" y2="6"/>
                                <line x1="12" y1="18" x2="12" y2="22"/>
                                <line x1="2" y1="12" x2="6" y2="12"/>
                                <line x1="18" y1="12" x2="22" y2="12"/>
                            </svg>
                            Find My Location
                        </button>
                    </div>
                </div>
                <div id="location-map"></div>
                <p class="form-help-text">
                    Type an address and click "Find Location", use "Find My Location" for GPS, or click on the map to update your location.
                </p>
            </div>

            <div style="margin-top: 2rem; text-align: right; display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" id="edit-profile-btn" onclick="enableEditMode()">Edit Profile</button>
                <button type="submit" id="save-changes-btn" style="display: none;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Include the modern image cropper component -->
{% include 'components/image_cropper_modal.html' %}
{% endblock volunteer_content %}

{% block scripts %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- MAP INITIALIZATION (with controls removed) ---
        const initialLat = parseFloat("{{ form.instance.latitude|default:'28.6139'|escapejs }}");
        const initialLon = parseFloat("{{ form.instance.longitude|default:'77.2090'|escapejs }}");
        const initialZoom = parseInt("{{ form.instance.latitude|yesno:'15,11' }}");

        const map = L.map('location-map', {
            zoomControl: false,
            attributionControl: false
        }).setView([initialLat, initialLon], initialZoom);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let marker = null;
        const latField = document.getElementById('id_latitude');
        const lonField = document.getElementById('id_longitude');
        const addressField = document.getElementById('id_address');

        if (latField.value && lonField.value) {
            marker = L.marker([latField.value, lonField.value]).addTo(map);
        }

        function updateMarkerAndFields(lat, lon, address = null) {
            latField.value = lat;
            lonField.value = lon;
            if (address) {
                addressField.value = address;
            }
            if (marker) {
                marker.setLatLng([lat, lon]);
            } else {
                marker = L.marker([lat, lon]).addTo(map);
            }
            map.setView([lat, lon], 15);
        }

        window.findAddressOnMap = function() {
            const address = addressField.value;
            if (!address) { alert("Please enter an address to find."); return; }
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(r => r.json())
                .then(d => {
                    if (d.length > 0) {
                        updateMarkerAndFields(d[0].lat, d[0].lon);
                    } else {
                        alert("Address not found.");
                    }
                });
        }
        
        // Find My Location using Geolocation API
        window.findMyLocation = function() {
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser', 'error');
                return;
            }
            
            const btn = document.querySelector('.find-my-location-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Finding...';
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Reverse geocode to get address
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                        .then(r => r.json())
                        .then(d => {
                            updateMarkerAndFields(lat, lon, d.display_name || 'Location found');
                            showToast('Location found successfully!', 'success');
                        })
                        .catch(() => {
                            updateMarkerAndFields(lat, lon, `${lat.toFixed(6)}, ${lon.toFixed(6)}`);
                            showToast('Location found!', 'success');
                        })
                        .finally(() => {
                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="3"/>
                                    <line x1="12" y1="2" x2="12" y2="6"/>
                                    <line x1="12" y1="18" x2="12" y2="22"/>
                                    <line x1="2" y1="12" x2="6" y2="12"/>
                                    <line x1="18" y1="12" x2="22" y2="12"/>
                                </svg> Find My Location`;
                            }
                        });
                },
                function(error) {
                    let message = 'Unable to find your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Please allow location access in your browser settings';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out';
                            break;
                    }
                    showToast(message, 'error');
                    
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="3"/>
                            <line x1="12" y1="2" x2="12" y2="6"/>
                            <line x1="12" y1="18" x2="12" y2="22"/>
                            <line x1="2" y1="12" x2="6" y2="12"/>
                            <line x1="18" y1="12" x2="22" y2="12"/>
                        </svg> Find My Location`;
                    }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json())
                .then(d => updateMarkerAndFields(lat, lon, d.display_name || 'Location selected'));
        });

        // Ensure map renders correctly
        setTimeout(() => map.invalidateSize(), 200);

        // --- EDIT/SAVE MODE FUNCTIONALITY ---
        const form = document.getElementById('profile-form');
        const editBtn = document.getElementById('edit-profile-btn');
        const saveBtn = document.getElementById('save-changes-btn');
        const imageUploadBtns = document.querySelectorAll('.image-upload-btn');
        const mapActionBtns = document.querySelectorAll('.map-action-btn');
        const skillsDisplay = document.getElementById('skills-display');
        const skillsEdit = document.getElementById('skills-edit');

        // Disable form fields by default
        function setReadOnlyMode() {
            document.body.classList.remove('edit-mode');
            
            // Disable all input fields except hidden ones
            const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="file"]):not([type="checkbox"]), textarea, select');
            inputs.forEach(input => {
                input.setAttribute('readonly', 'readonly');
                input.style.pointerEvents = 'none';
                input.style.backgroundColor = '#f9fafb';
            });
            
            // Disable checkboxes
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.disabled = true;
            });

            // Hide image upload buttons
            imageUploadBtns.forEach(btn => btn.style.display = 'none');
            
            // Disable map action buttons
            mapActionBtns.forEach(btn => btn.disabled = true);
            
            // Disable map clicks
            map.off('click');

            // Show Edit button, hide Save button
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
        }

        // Enable edit mode
        window.enableEditMode = function() {
            document.body.classList.add('edit-mode');
            
            const inputs = form.querySelectorAll('input:not([type="hidden"]):not([type="file"]):not([type="checkbox"]), textarea, select');
            inputs.forEach(input => {
                input.removeAttribute('readonly');
                input.style.pointerEvents = 'auto';
                input.style.backgroundColor = 'white';
            });
            
            // Enable checkboxes
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.disabled = false;
            });

            // Show image upload buttons
            imageUploadBtns.forEach(btn => btn.style.display = 'inline-block');
            
            // Enable map action buttons
            mapActionBtns.forEach(btn => btn.disabled = false);
            
            // Enable map clicks
            map.on('click', function (e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(r => r.json())
                    .then(d => updateMarkerAndFields(lat, lon, d.display_name || 'Location selected'));
            });

            // Hide Edit button, show Save button
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        }

        // Initialize in read-only mode
        setReadOnlyMode();
    });
</script>
{% endblock scripts %}

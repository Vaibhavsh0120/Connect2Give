{% extends 'volunteer/base.html' %}

{% block title %}Manage Camps - {{ block.super }}{% endblock %}

{% block page_title %}Manage NGO Registrations{% endblock %}
{% block page_description %}Join NGOs to see their available donation camps.{% endblock %}

{% block volunteer_content %}
    <div class="content-card">
        <form method="GET" action="{% url 'volunteer_manage_camps' %}" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" name="q" placeholder="Search by NGO name or address..." value="{{ request.GET.q }}" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <button type="submit" class="action-button">Search</button>
                {% if request.GET.q %}
                <a href="{% url 'volunteer_manage_camps' %}" class="action-button-danger">Clear</a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="content-card">
        <h3>Available NGOs to Join</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>NGO Name</th>
                    <th>Address</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="available-ngos-tbody">
                {% for ngo in available_ngos %}
                <tr id="available-ngo-{{ ngo.pk }}">
                    <td data-label="NGO Name"><strong>{{ ngo.ngo_name }}</strong></td>
                    <td data-label="Address">{{ ngo.address }}</td>
                    <td data-label="Action">
                        <button type="button" class="action-button" onclick="joinNGO({{ ngo.pk }}, '{{ ngo.ngo_name|escapejs }}', '{{ ngo.address|escapejs }}')">Join</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">
                        <div class="empty-state">
                            <div class="empty-state-icon" style="font-size: 3rem; margin-bottom: 1rem;">üè¢</div>
                            <p style="font-size: 1.125rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">No New NGOs Available</p>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">All NGOs in the platform are already in your registered list.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="content-card">
        <h3>My Registered NGOs</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>NGO Name</th>
                    <th>Date Joined</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="registered-ngos-tbody">
                {% for ngo in registered_ngos %}
                <tr id="registered-ngo-{{ ngo.pk }}">
                    <td data-label="NGO Name"><strong>{{ ngo.ngo_name }}</strong></td>
                    <td data-label="Date Joined">{{ ngo.date_joined|date:"d M Y" }}</td>
                    <td data-label="Action">
                        <button type="button" class="action-button-danger" onclick="leaveNGO({{ ngo.pk }})">Leave</button>
                    </td>
                </tr>
                {% empty %}
                <tr id="registered-empty">
                    <td colspan="3">
                        <div class="empty-state">
                            <div class="empty-state-icon" style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                            <p style="font-size: 1.125rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Not Registered with Any NGOs</p>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Join an NGO from the list above to start receiving deliveries to their camps.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    function joinNGO(ngoId, ngoName, ngoAddress) {
        const csrftoken = getCookie('csrftoken');
        
        fetch(`/register_with_ngo/${ngoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove from available NGOs table
                const availableRow = document.getElementById(`available-ngo-${ngoId}`);
                if (availableRow) {
                    availableRow.remove();
                }
                
                // Add to registered NGOs table
                const registeredTbody = document.getElementById('registered-ngos-tbody');
                const emptyRow = document.getElementById('registered-empty');
                if (emptyRow) {
                    emptyRow.remove();
                }
                
                const today = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const newRow = document.createElement('tr');
                newRow.id = `registered-ngo-${ngoId}`;
                newRow.innerHTML = `
                    <td data-label="NGO Name"><strong>${ngoName}</strong></td>
                    <td data-label="Date Joined">${today}</td>
                    <td data-label="Action">
                        <button type="button" class="action-button-danger" onclick="leaveNGO(${ngoId})">Leave</button>
                    </td>
                `;
                registeredTbody.appendChild(newRow);
                
                showToast(`Successfully registered with ${ngoName}`, 'success');
            } else {
                showToast(data.message || 'Failed to join NGO', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        });
    }
    
    function leaveNGO(ngoId) {
        if (!confirm('Are you sure you want to leave this NGO?')) {
            return;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        fetch(`/unregister_from_ngo/${ngoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // NO RELOAD: Remove from registered NGOs table
                const registeredRow = document.getElementById(`registered-ngo-${ngoId}`);
                if (registeredRow) {
                    registeredRow.style.transition = 'opacity 0.3s ease-out';
                    registeredRow.style.opacity = '0';
                    setTimeout(() => {
                        registeredRow.remove();
                        
                        // Check if table is now empty
                        const registeredTbody = document.getElementById('registered-ngos-tbody');
                        if (registeredTbody.children.length === 0) {
                            const emptyRow = document.createElement('tr');
                            emptyRow.id = 'registered-empty';
                            emptyRow.innerHTML = '<td colspan="3"><div class="empty-state"><div class="empty-state-icon" style="font-size: 3rem; margin-bottom: 1rem;">üìã</div><p style="font-size: 1.125rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Not Registered with Any NGOs</p></div></td>';
                            registeredTbody.appendChild(emptyRow);
                        }
                    }, 300);
                }
                
                // Add NGO back to available list
                if (data.ngo_name) {
                    const availableTbody = document.getElementById('available-ngos-tbody');
                    if (availableTbody) {
                        // Remove empty state if exists
                        const emptyStateRow = availableTbody.querySelector('tr:has(.empty-state)');
                        if (emptyStateRow) {
                            emptyStateRow.remove();
                        }
                        
                        const newRow = document.createElement('tr');
                        newRow.id = `available-ngo-${ngoId}`;
                        newRow.innerHTML = `
                            <td data-label="NGO Name"><strong>${data.ngo_name}</strong></td>
                            <td data-label="Address">${data.address || ''}</td>
                            <td data-label="Action">
                                <button type="button" class="action-button" onclick="joinNGO(${ngoId}, '${data.ngo_name.replace(/'/g, "\\'")}', '${(data.address || '').replace(/'/g, "\\'")}'  )">Join</button>
                            </td>
                        `;
                        availableTbody.appendChild(newRow);
                    }
                }
                
                showToast(data.message || 'Successfully left NGO', 'success');
            } else {
                showToast(data.message || 'Failed to leave NGO', 'error');
            }
        })
        .catch(error => {
            console.error('[v0] Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        });
    }
</script>
{% endblock %}

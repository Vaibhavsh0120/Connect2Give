{% extends 'restaurant/base.html' %}
{% load static %}

{% block title %}Manage Donations - {{ block.super }}{% endblock %}

{% block page_title %}Manage Donations{% endblock %}
{% block page_description %}Create new donations and view your history.{% endblock %}

{% block restaurant_content %}
    {% if messages %}
        {% for message in messages %}
            <div class="success-message">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Tabbed navigation interface -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab(event, 'create-donation')">Create Donation</button>
        <button class="tab-button" onclick="switchTab(event, 'donation-history')">Donation History</button>
    </div>

    <!-- Create Donation Tab -->
    <div id="create-donation" class="tab-content active">
        <div class="content-card">
            <h3>Post a New Food Donation</h3>
            <form method="POST" action="{% url 'restaurant_donations' %}">
                {% csrf_token %}
                <div class="form-group">
                    {{ form.food_description.label_tag }}
                    {{ form.food_description }}
                </div>
                <div class="form-group">
                    {{ form.quantity.label_tag }}
                    {{ form.quantity }}
                </div>
                <div class="form-group">
                    {{ form.pickup_address.label_tag }}
                    <div class="address-group">
                        {{ form.pickup_address }}
                    </div>
                    <div class="address-actions">
                        <div class="address-buttons">
                            <button type="button" class="btn-secondary" onclick="useDefaultAddress()">Use Default Address</button>
                            <button type="button" onclick="useCurrentLocation()">Use Current Location</button>
                        </div>
                        <p id="location-status" class="form-help-text"></p>
                    </div>
                </div>
                <button type="submit">Post Donation</button>
            </form>
        </div>
    </div>

    <!-- Donation History Tab -->
    <div id="donation-history" class="tab-content">
        <div class="content-card">
            <h3>My Donation History</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Date Posted</th>
                    </tr>
                </thead>
                <tbody>
                    {% for donation in donations %}
                    <tr>
                        <td data-label="Description">{{ donation.food_description }}</td>
                        <td data-label="Quantity">{{ donation.quantity }}</td>
                        <td data-label="Status"><span class="status-badge status-{{ donation.status|lower }}">{{ donation.get_status_display }}</span></td>
                        <td data-label="Date Posted">{{ donation.created_at|date:"d M Y, H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="empty-state">You have not posted any donations yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock restaurant_content %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'js/common.js' %}"></script>
<script>
    // Tab switching functionality
    function switchTab(event, tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }
    
    // Show success toast on page load if messages exist
    document.addEventListener('DOMContentLoaded', function() {
        const messages = document.querySelectorAll('.success-message');
        if (messages.length > 0) {
            messages.forEach(msg => {
                showToast(msg.textContent, 'success');
                msg.style.display = 'none';
            });
        }
    });

    // Function to use the default address
    function useDefaultAddress() {
        const addressField = document.getElementById('id_pickup_address');
        const status = document.getElementById('location-status');
        addressField.value = "{{ default_address|escapejs }}";
        status.textContent = 'Default address has been set.';
        status.style.color = 'var(--text-secondary)';
    }

    // Geolocation for pickup address
    function useCurrentLocation() {
        const addressField = document.getElementById('id_pickup_address');
        const status = document.getElementById('location-status');

        status.textContent = 'Fetching location...';
        status.style.color = 'var(--accent-blue)';

        if (!navigator.geolocation) {
            status.textContent = 'Geolocation is not supported by your browser.';
            status.style.color = 'var(--accent-red)';
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.display_name) {
                            addressField.value = data.display_name;
                            status.textContent = 'Address updated from your current location!';
                            status.style.color = 'var(--accent-green)';
                        } else {
                            status.textContent = 'Could not find a valid address for your location.';
                            status.style.color = 'var(--accent-red)';
                        }
                    })
                    .catch(() => {
                        status.textContent = 'Error looking up address.';
                        status.style.color = 'var(--accent-red)';
                    });
            },
            () => {
                status.textContent = 'Unable to retrieve your location.';
                status.style.color = 'var(--accent-red)';
            }
        );
    }
</script>
{% endblock scripts %}

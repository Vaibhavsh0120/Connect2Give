{% extends 'ngo/base.html' %}

{% block title %}Manage Camps - {{ block.super }}{% endblock %}

{% block page_title %}Manage Camps{% endblock %}
{% block page_description %}Create new camps and manage your existing ones{% endblock %}

{% block ngo_content %}
    <div class="camps-container">
        {% if messages %}
            {% for message in messages %}
                <div class="success-message">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <div class="tab-navigation">
            <button class="tab-button {% if not active_tab %}active{% endif %}" onclick="switchTab(event, 'create-camp')">Create Camp</button>
            <button class="tab-button {% if active_tab == 'history' %}active{% endif %}" onclick="switchTab(event, 'camps-history')">Camps History</button>
        </div>

        <div id="create-camp" class="tab-content {% if not active_tab %}active{% endif %}">
            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Create a New Donation Camp</h3>
                <form method="POST" action="{% url 'ngo_manage_camps' %}">
                    {% csrf_token %}
                    {{ form.latitude }}
                    {{ form.longitude }}

                    <div class="form-group">
                        {{ form.name.label_tag }}
                        {{ form.name }}
                    </div>
                    
                    <div class="form-group">
                        {{ form.location_address.label_tag }}
                        <div class="address-group">
                            {{ form.location_address }}
                            <button type="button" onclick="findAddressOnMap()">Find Location</button>
                        </div>
                    </div>

                    <div id="camp-map"></div>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1.5rem;">
                        Type an address and click "Find Location", or click on the map to set the location.
                    </p>

                    <div class="form-group">
                        {{ form.start_time.label_tag }}
                        {{ form.start_time }}
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="submit">Create Camp</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="camps-history" class="tab-content {% if active_tab == 'history' %}active{% endif %}">
            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Active Camps</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Camp Name</th>
                            <th>Location</th>
                            <th>Start Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for camp in active_camps %}
                        <tr>
                            <td data-label="Camp Name"><strong>{{ camp.name }}</strong></td>
                            <td data-label="Location">{{ camp.location_address }}</td>
                            <td data-label="Start Time">{{ camp.start_time|date:"d M Y, H:i" }}</td>
                            <td data-label="Status"><span style="color: var(--accent-green); font-weight: 500;">Active</span></td>
                            <td data-label="Action">
                                <form action="{% url 'mark_camp_as_completed' camp.pk %}" method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button">Mark as Completed</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="empty-state">You have no active camps at the moment.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="content-card">
                <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Completed Deliveries - Rate Volunteers</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Restaurant</th>
                            <th>Food Description</th>
                            <th>Volunteer</th>
                            <th>Delivered To</th>
                            <th>Delivered At</th>
                            <th>Rating</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for donation in delivered_donations %}
                        <tr>
                            <td data-label="Restaurant"><strong>{{ donation.restaurant.restaurant_name }}</strong></td>
                            <td data-label="Food Description">{{ donation.food_description }}</td>
                            <td data-label="Volunteer">{{ donation.assigned_volunteer.full_name }}</td>
                            <td data-label="Delivered To">{{ donation.target_camp.name }}</td>
                            <td data-label="Delivered At">{{ donation.delivered_at|date:"d M Y, H:i" }}</td>
                            <td data-label="Rating">
                                {% if donation.rating %}
                                    <span style="color: #f59e0b;">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= donation.rating %}⭐{% endif %}
                                        {% endfor %}
                                        ({{ donation.rating }}/5)
                                    </span>
                                {% else %}
                                    <span style="color: var(--text-muted);">Not rated</span>
                                {% endif %}
                            </td>
                            <td data-label="Action">
                                {% if not donation.rating %}
                                    <button type="button" class="action-button" onclick="openRatingModal({{ donation.pk }}, '{{ donation.assigned_volunteer.full_name|escapejs }}')">Rate Volunteer</button>
                                {% else %}
                                    <button type="button" class="action-button" style="opacity: 0.6; cursor: not-allowed;" disabled>Already Rated</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="empty-state">No completed deliveries to rate yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="ratingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
            <h3 style="margin-top: 0;">Rate Volunteer Performance</h3>
            <p id="volunteerName" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
            
            <form id="ratingForm" method="POST">
                {% csrf_token %}
                <input type="hidden" id="donationId" name="donation_id">
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Rating (1-5 stars)</label>
                    <div id="starRating" style="font-size: 2rem; cursor: pointer;">
                        <span data-rating="1">☆</span>
                        <span data-rating="2">☆</span>
                        <span data-rating="3">☆</span>
                        <span data-rating="4">☆</span>
                        <span data-rating="5">☆</span>
                    </div>
                    <input type="hidden" id="ratingValue" name="rating" required>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label for="review" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Review (Optional)</label>
                    <textarea id="review" name="review" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-family: inherit;"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="closeRatingModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Submit Rating</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        let currentRating = 0;
        
        function openRatingModal(donationId, volunteerName) {
            document.getElementById('ratingModal').style.display = 'flex';
            document.getElementById('donationId').value = donationId;
            document.getElementById('volunteerName').textContent = 'Rating delivery by: ' + volunteerName;
            currentRating = 0;
            updateStars(0);
        }
        
        function closeRatingModal() {
            document.getElementById('ratingModal').style.display = 'none';
            document.getElementById('ratingForm').reset();
            currentRating = 0;
            updateStars(0);
        }
        
        function updateStars(rating) {
            const stars = document.querySelectorAll('#starRating span');
            stars.forEach((star, index) => {
                star.textContent = index < rating ? '★' : '☆';
                star.style.color = index < rating ? '#f59e0b' : '#d1d5db';
            });
        }
        
        // Star rating interaction
        document.querySelectorAll('#starRating span').forEach(star => {
            star.addEventListener('click', function() {
                currentRating = parseInt(this.getAttribute('data-rating'));
                document.getElementById('ratingValue').value = currentRating;
                updateStars(currentRating);
            });
            
            star.addEventListener('mouseenter', function() {
                const hoverRating = parseInt(this.getAttribute('data-rating'));
                updateStars(hoverRating);
            });
        });
        
        document.getElementById('starRating').addEventListener('mouseleave', function() {
            updateStars(currentRating);
        });
        
        // Form submission
        document.getElementById('ratingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (currentRating === 0) {
                alert('Please select a rating');
                return;
            }
            
            const donationId = document.getElementById('donationId').value;
            const formData = new FormData(this);
            
            fetch(`/donation/rate/${donationId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    closeRatingModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            });
        });
    </script>
    <script>
        let map; // Declare map variable in a broader scope

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize map centered on Delhi
            map = L.map('camp-map', {
                zoomControl: false,
                attributionControl: false
            }).setView([28.6139, 77.2090], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            let marker = null;
            const latField = document.getElementById('id_latitude');
            const lonField = document.getElementById('id_longitude');
            const addressField = document.getElementById('id_location_address');

            function updateMarkerAndFields(lat, lon, address = null) {
                latField.value = lat;
                lonField.value = lon;
                if (address) {
                    addressField.value = address;
                }
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon]).addTo(map);
                }
                map.setView([lat, lon], 15);
            }

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.display_name || 'Could not find address';
                        updateMarkerAndFields(lat, lon, address);
                    });
            });

            // Make findAddressOnMap globally accessible
            window.findAddressOnMap = function() {
                const address = addressField.value;
                if (!address) {
                    alert("Please enter an address to find.");
                    return;
                }
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const lat = data[0].lat;
                            const lon = data[0].lon;
                            updateMarkerAndFields(lat, lon);
                        } else {
                            alert("Address not found.");
                        }
                    });
            }
        });

        // Tab switching functionality
        function switchTab(event, tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // Fix for map not rendering correctly in a hidden tab
            if (tabId === 'create-camp') {
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 10); // A small delay is sometimes needed
            }
        }
    </script>
{% endblock %}

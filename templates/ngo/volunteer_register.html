{% extends 'ngo/base.html' %}
{% load static %}

{% block title %}Add Volunteer - NGO Dashboard{% endblock %}

{% block page_title %}Add New Volunteer{% endblock %}
{% block page_description %}Recruit volunteers to support food donation pickups and deliveries{% endblock %}

{% block ngo_content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="register-volunteer-page">
    <a href="{% url 'ngo_manage_volunteers' %}" class="back-link">
        <svg class="back-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        <span>Back to Volunteers List</span>
    </a>

    <div class="content-card volunteer-form-card">
        <h3>Volunteer Details</h3>
        <form action="{% url 'ngo_register_volunteer' %}" method="POST" enctype="multipart/form-data" class="volunteer-form">
            {% csrf_token %}
            
            <input type="hidden" name="latitude" id="id_volunteer_latitude">
            <input type="hidden" name="longitude" id="id_volunteer_longitude">
            
            <div class="form-row">
                <div class="form-column">
                    <div class="form-group">
                        <label for="id_full_name">
                            Full Name <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            name="full_name" 
                            id="id_full_name" 
                            placeholder="John Doe"
                            value="{{ form.full_name.value|default:'' }}"
                            required
                            pattern="[A-Za-z\s]+"
                            oninput="this.value = this.value.replace(/[^A-Za-z\s]/g, '')"
                        >
                        {% if form.full_name.errors %}
                            <p class="field-error">{{ form.full_name.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help-text">Alphabetic characters and spaces only</p>
                    </div>

                    <div class="form-group">
                        <label for="id_username">
                            Username <span class="required">*</span>
                        </label>
                        <div class="username-input-group">
                            <input 
                                type="text" 
                                name="username" 
                                id="id_username" 
                                placeholder="volunteer_username"
                                value="{{ form.username.value|default:'' }}"
                                autocomplete="off"
                                required
                            >
                            <button type="button" class="btn-check-username" onclick="checkUsernameAvailability()">
                                Check
                            </button>
                        </div>
                        {% if form.username.errors %}
                            <p class="field-error">{{ form.username.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help-text" id="username-status">Unique username for login (letters, numbers, underscores, hyphens)</p>
                    </div>

                    <div class="form-group">
                        <label for="id_email">
                            Email Address <span class="required">*</span>
                        </label>
                        <input 
                            type="email" 
                            name="email" 
                            id="id_email" 
                            placeholder="volunteer@example.com"
                            value="{{ form.email.value|default:'' }}"
                            required
                        >
                        {% if form.email.errors %}
                            <p class="field-error">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_phone_number">
                            Phone Number <span class="required">*</span>
                        </label>
                        <input 
                            type="tel" 
                            name="phone_number" 
                            id="id_phone_number" 
                            placeholder="9876543210"
                            value="{{ form.phone_number.value|default:'' }}"
                            required
                            pattern="[0-9]{10}"
                            maxlength="10"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);"
                        >
                        {% if form.phone_number.errors %}
                            <p class="field-error">{{ form.phone_number.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help-text">10 digits only</p>
                    </div>

                    <div class="form-group">
                        <label>
                            Aadhar Card Number <span class="required">*</span>
                        </label>
                        <input type="hidden" name="aadhar_number" id="id_aadhar_number" value="{{ form.aadhar_number.value|default:'' }}">
                        <div class="aadhar-input-group">
                            <input type="text" class="aadhar-part" maxlength="4" data-index="0" placeholder="1234" inputmode="numeric">
                            <span class="aadhar-separator">-</span>
                            <input type="text" class="aadhar-part" maxlength="4" data-index="1" placeholder="5678" inputmode="numeric">
                            <span class="aadhar-separator">-</span>
                            <input type="text" class="aadhar-part" maxlength="4" data-index="2" placeholder="9012" inputmode="numeric">
                        </div>
                        {% if form.aadhar_number.errors %}
                            <p class="field-error">{{ form.aadhar_number.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help-text">Required for verification (12 digits)</p>
                    </div>
                </div>
                
                <div class="form-column">
                    <div class="form-group">
                        <label>Profile Picture (Optional)</label>
                        <div class="profile-upload-container">
                            <div class="profile-preview">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Crect fill='%23e2e8f0' width='120' height='120'/%3E%3Ctext fill='%23475569' font-family='Arial' font-size='12' x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle'%3EPhoto%3C/text%3E%3C/svg%3E" alt="Profile Preview" id="profile_picture_preview">
                            </div>
                            <input type="file" id="id_profile_picture_input" accept="image/*" onchange="modernCropperOpen(event, 1, 'id_profile_picture')" style="display: none;">
                            <input type="hidden" name="profile_picture" id="id_profile_picture">
                            <button type="button" class="btn-upload" onclick="document.getElementById('id_profile_picture_input').click()">
                                Choose Photo
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Skills</label>
                        <div class="skills-checkbox-group">
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="driving" {% if 'driving' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">Driving</span>
                            </label>
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="first_aid" {% if 'first_aid' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">First Aid</span>
                            </label>
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="cooking" {% if 'cooking' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">Cooking</span>
                            </label>
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="logistics" {% if 'logistics' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">Logistics</span>
                            </label>
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="communication" {% if 'communication' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">Communication</span>
                            </label>
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="medical" {% if 'medical' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">Medical</span>
                            </label>
                            <label class="skill-checkbox-item">
                                <input type="checkbox" name="skills" value="packaging" {% if 'packaging' in form.skills.value %}checked{% endif %}>
                                <span class="skill-label">Packaging</span>
                            </label>
                        </div>
                        <p class="form-help-text">Select applicable skills</p>
                    </div>
                </div>
            </div>

            <div class="form-group address-section">
                <label for="id_volunteer_address">Primary Address</label>
                <div class="address-input-group">
                    <textarea 
                        name="address" 
                        id="id_volunteer_address" 
                        rows="3" 
                        placeholder="Enter volunteer's primary address..."
                    >{{ form.address.value|default:'' }}</textarea>
                    <div class="address-buttons">
                        <button type="button" class="btn-map-action" onclick="findAddressOnMap()">Find on Map</button>
                    </div>
                </div>
                <div id="volunteer-location-map"></div>
                <p class="form-help-text">Click on the map or search to set location</p>
            </div>

            <button type="submit" class="btn submit-btn">
                Register Volunteer
            </button>
        </form>

        <div class="info-note">
            <p>
                <strong>Note:</strong> An invitation email with temporary credentials will be sent to the volunteer. They must change their password on first login.
            </p>
        </div>
    </div>
</div>

<div id="errorPopupModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <div class="modal-header error-header">
            <div class="icon-circle">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            </div>
            <h3>Error Occurred</h3>
        </div>
        <div class="modal-body">
            <p id="errorPopupMessage">Something went wrong.</p>
        </div>
        <div class="modal-footer">
            <button onclick="closeErrorPopup()" class="btn-close-modal">Understood</button>
        </div>
    </div>
</div>

{% include 'components/image_cropper_modal.html' %}

<style>
    .register-volunteer-page {
        max-width: 1000px;
        margin: 0 auto; 
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1.5rem;
        transition: color 0.2s ease;
    }

    .back-link:hover {
        color: var(--accent-primary);
    }

    .back-icon {
        flex-shrink: 0;
    }

    .volunteer-form-card {
        padding: 2rem;
    }

    .volunteer-form-card h3 {
        margin-bottom: 1.5rem;
    }

    .volunteer-form {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .form-column {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .required {
        color: var(--accent-red);
    }

    .field-error {
        color: var(--accent-red);
        font-size: 0.8125rem;
        margin-top: 0.25rem;
        margin-bottom: 0;
    }

    /* Username input group */
    .username-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .username-input-group input {
        flex: 1;
    }

    .btn-check-username {
        padding: 0.5rem 1rem;
        background: #3b82f6;
        color: white;
        border: 1px solid #3b82f6;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .btn-check-username:hover {
        background: #2563eb;
        border-color: #2563eb;
    }

    #username-status.available {
        color: var(--accent-green);
    }

    #username-status.unavailable {
        color: var(--accent-red);
    }

    /* Profile upload */
    .profile-upload-container {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .profile-preview {
        width: 100px;
        height: 100px;
        border-radius: var(--radius);
        overflow: hidden;
        border: 2px solid var(--border);
    }

    .profile-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .btn-upload {
        padding: 0.5rem 1rem;
        background: var(--accent-primary-light);
        color: var(--accent-primary);
        border: 1px solid var(--accent-primary);
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.875rem;
    }

    .btn-upload:hover {
        background: var(--accent-primary);
        color: white;
    }

    /* Skills checkbox group */
    .skills-checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .skill-checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--bg-card-hover);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s;
    }

    .skill-checkbox-item:hover {
        border-color: var(--accent-primary);
    }

    .skill-checkbox-item input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    .skill-checkbox-item input[type="checkbox"]:checked + .skill-label {
        color: var(--accent-primary);
        font-weight: 600;
    }

    .skill-checkbox-item:has(input:checked) {
        background: var(--accent-primary-light);
        border-color: var(--accent-primary);
    }

    .skill-label {
        font-size: 0.875rem;
    }

    /* Address section */
    .address-section {
        margin-top: 1rem;
    }

    .address-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .address-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-map-action {
        padding: 0.5rem 1rem;
        background: var(--accent-primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.875rem;
    }

    .btn-map-action:hover {
        background: var(--accent-primary-hover);
    }

    #volunteer-location-map {
        height: 300px;
        width: 100%;
        border-radius: var(--radius);
        margin-top: 0.75rem;
        border: 1px solid var(--border);
    }

    .submit-btn {
        margin-top: 1rem;
    }

    .info-note {
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--accent-primary-light);
        border-left: 4px solid var(--accent-primary);
        border-radius: var(--radius);
    }

    .info-note p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(2px);
    }

    .modal-card {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes modalPop {
        0% { transform: scale(0.9); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .modal-header.error-header {
        background-color: #fef2f2;
        padding: 1.5rem;
        text-align: center;
        border-bottom: 1px solid #fee2e2;
    }

    .icon-circle {
        width: 48px;
        height: 48px;
        background-color: #fee2e2;
        color: #ef4444;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }

    .modal-header h3 {
        color: #991b1b;
        margin: 0;
        font-size: 1.25rem;
    }

    .modal-body {
        padding: 1.5rem;
        text-align: center;
        color: #4b5563;
        font-size: 1rem;
        line-height: 1.5;
    }

    .modal-footer {
        padding: 1rem 1.5rem 1.5rem;
        display: flex;
        justify-content: center;
    }

    .btn-close-modal {
        background-color: #ef4444;
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
    }

    .btn-close-modal:hover {
        background-color: #dc2626;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .register-volunteer-page {
            max-width: 100%;
        }

        .volunteer-form-card {
            padding: 1.5rem;
        }

        .back-link {
            margin-bottom: 1rem;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }

    /* Aadhar Card Special Input */
    .aadhar-input-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .aadhar-part {
        width: 90px;
        text-align: center;
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: 3px;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-input, white);
        transition: all 0.2s ease;
    }

    .aadhar-part:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 173, 181, 0.15);
        outline: none;
    }

    .aadhar-part::placeholder {
        color: #cbd5e1;
        font-weight: 400;
        letter-spacing: 2px;
    }

    .aadhar-separator {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-muted, #94a3b8);
    }

    @media (max-width: 768px) {
        .aadhar-part {
            width: 70px;
            font-size: 1rem;
            padding: 0.5rem;
        }
        .aadhar-separator {
            font-size: 1.25rem;
        }
    }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- AADHAR CARD 3-BOX INPUT LOGIC ---
    const aadharHidden = document.getElementById('id_aadhar_number');
    const aadharParts = document.querySelectorAll('.aadhar-part');
    
    function updateHiddenAadhar() {
        const part1 = aadharParts[0].value;
        const part2 = aadharParts[1].value;
        const part3 = aadharParts[2].value;
        aadharHidden.value = `${part1}${part2}${part3}`;
    }
    
    // Initialize from hidden field if exists
    if (aadharHidden.value) {
        const val = aadharHidden.value.replace(/\D/g, '');
        if (val.length > 0) aadharParts[0].value = val.slice(0, 4);
        if (val.length > 4) aadharParts[1].value = val.slice(4, 8);
        if (val.length > 8) aadharParts[2].value = val.slice(8, 12);
    }
    
    aadharParts.forEach((input, idx) => {
        // Allow numbers only + auto-advance
        input.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '');
            
            // Auto-advance to next box when full
            if (e.target.value.length === 4 && idx < 2) {
                aadharParts[idx + 1].focus();
            }
            updateHiddenAadhar();
        });
        
        // Handle Backspace - move to previous box when empty
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value.length === 0 && idx > 0) {
                e.preventDefault();
                const prev = aadharParts[idx - 1];
                prev.focus();
                prev.setSelectionRange(prev.value.length, prev.value.length);
            }
        });
        
        // Handle Paste - intelligently distribute across boxes
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = (e.clipboardData || window.clipboardData).getData('text');
            // Remove all non-digits and spaces
            const cleanData = pasteData.replace(/[\D\s]/g, '').slice(0, 12);
            
            if (cleanData) {
                aadharParts[0].value = cleanData.slice(0, 4);
                aadharParts[1].value = cleanData.slice(4, 8);
                aadharParts[2].value = cleanData.slice(8, 12);
                
                // Focus logic after paste
                if (cleanData.length >= 12) {
                    aadharParts[2].focus();
                } else if (cleanData.length > 8) {
                    aadharParts[2].focus();
                } else if (cleanData.length > 4) {
                    aadharParts[1].focus();
                } else {
                    aadharParts[0].focus();
                }
                
                updateHiddenAadhar();
            }
        });
    });

    // Initialize map
    const map = L.map('volunteer-location-map', {
        zoomControl: true,
        attributionControl: false
    }).setView([28.6139, 77.2090], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let marker = null;
    const latField = document.getElementById('id_volunteer_latitude');
    const lonField = document.getElementById('id_volunteer_longitude');
    const addressField = document.getElementById('id_volunteer_address');

    function updateMarkerAndFields(lat, lon, address = null) {
        latField.value = lat;
        lonField.value = lon;
        if (address) {
            addressField.value = address;
        }
        if (marker) {
            marker.setLatLng([lat, lon]);
        } else {
            marker = L.marker([lat, lon]).addTo(map);
        }
        map.setView([lat, lon], 15);
    }

    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(data => {
                const address = data.display_name || 'Location selected';
                updateMarkerAndFields(lat, lon, address);
            });
    });

    window.findAddressOnMap = function() {
        const address = addressField.value;
        if (!address) {
            alert('Please enter an address to find.');
            return;
        }
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    updateMarkerAndFields(lat, lon);
                } else {
                    alert('Address not found.');
                }
            });
    };
});

// Check username availability
function checkUsernameAvailability() {
    const usernameInput = document.getElementById('id_username');
    const statusEl = document.getElementById('username-status');
    const username = usernameInput.value.trim().toLowerCase();
    
    if (!username || username.length < 3) {
        statusEl.textContent = 'Username must be at least 3 characters';
        statusEl.className = 'form-help-text unavailable';
        return;
    }
    
    statusEl.textContent = 'Checking...';
    statusEl.className = 'form-help-text';
    
    fetch(`/api/check-username/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                statusEl.textContent = 'Username is available';
                statusEl.className = 'form-help-text available';
            } else {
                statusEl.textContent = data.message || 'Username is already taken';
                statusEl.className = 'form-help-text unavailable';
            }
        })
        .catch(error => {
            statusEl.textContent = 'Error checking username';
            statusEl.className = 'form-help-text unavailable';
        });
}

// Modal Logic
function closeErrorPopup() {
    document.getElementById('errorPopupModal').style.display = 'none';
}

// Check if Django passed an error_popup variable
{% if error_popup %}
    document.addEventListener('DOMContentLoaded', function() {
        // Use a small timeout to ensure it pops up after other init
        setTimeout(function() {
            const message = "{{ error_popup|escapejs }}";
            const msgElement = document.getElementById('errorPopupMessage');
            if(msgElement) {
                msgElement.textContent = message;
                document.getElementById('errorPopupModal').style.display = 'flex';
            }
        }, 100);
    });
{% endif %}
</script>
{% endblock %}